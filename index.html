<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dynamic Row Form with Preview</title>
  <style>
    .row { margin-bottom: 10px; }
    .row input, .row select { margin-right: 10px; }
    .deleteBtn { background-color: red; color: white; border: none; cursor: pointer; padding: 5px; }
    .hidden { display: none; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    table, th, td { border: 1px solid black; }
    th, td { padding: 10px; text-align: left; }
    .backBtn, .submitBtn { background-color: #007BFF; color: white; border: none; padding: 10px 20px; cursor: pointer; margin-top: 20px; }
    .submitBtn { background-color: #28a745; }
  </style>
</head>
<body>
  <h2 id="pageTitle">Translation/Proof Reading Details</h2>

  <div id="formPage">
    <form id="dynamicForm">
      <div id="rowsContainer">
        <div class="row" id="row_1">
          <input type="date" name="r1c1" required>
          <select name="r1c2" required>
            <option value="Translation">Translation</option>
            <option value="Proof reading">Proof reading</option>
          </select>
          <select name="r1c3" required>
            <option value="nn1">nn1</option>
            <option value="gds">gds</option>
            <option value="gdsg">gdsg</option>
          </select>
          <input type="text" name="r1c4" placeholder="Particular/Description" required>
          <input type="number" name="r1c5" placeholder="Word Count" required>
          <input type="number" name="r1c6" placeholder="Rate(in Rs)" required>
          <button type="button" class="deleteBtn" onclick="deleteRow(1)">Delete</button>
        </div>
      </div>

      <button type="button" id="addRowBtn">Add Row</button>
      <button type="submit">Preview</button>
    </form>
  </div>

  <div id="previewPage" class="hidden">
    <table id="previewTable">
      <thead>
        <tr>
          <th>Date</th>
          <th>Type</th>
          <th>Provider</th>
          <th>Particular/Description</th>
          <th>Word Count</th>
          <th>Rate in Rs</th>
          <th>Total amount in Rs</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <button class="backBtn" onclick="goBackToForm()">Back to Form</button>
    <button class="submitBtn" onclick="submitData()">Submit Data</button> 
    <br><br>
    <div class="rp" id="rp">
 <p id="response"></p>
    </div> 
  </div>
<script>
  const responseParagraph = document.getElementById('response');
  let rowCount = 1;
  let previewData = null; // ðŸ”¹ Store preview result globally

  // Add new row
  document.getElementById('addRowBtn').addEventListener('click', function () {
    rowCount++;
    const newRow = document.createElement('div');
    newRow.classList.add('row');
    newRow.id = `row_${rowCount}`;
    newRow.innerHTML = `
      <input type="date" name="r${rowCount}c1" required>
      <select name="r${rowCount}c2" required>
        <option value="Translation">Translation</option>
        <option value="Proof reading">Proof reading</option>
      </select>
      <select name="r${rowCount}c3" required>
        <option value="nn1">nn1</option>
        <option value="gds">gds</option>
        <option value="gdsg">gdsg</option>
      </select>
      <input type="text" name="r${rowCount}c4" placeholder="Particular/Description" required>
      <input type="number" name="r${rowCount}c5" placeholder="Word Count" required>
      <input type="number" name="r${rowCount}c6" placeholder="Rate(in Rs)" required>
      <button type="button" class="deleteBtn" onclick="deleteRow(${rowCount})">Delete</button>
    `;
    document.getElementById('rowsContainer').appendChild(newRow);
  });

  // Delete a row
  function deleteRow(rowId) {
    const row = document.getElementById(`row_${rowId}`);
    if (row) row.remove();
  }

  // Back to form
  function goBackToForm() {
    document.getElementById('formPage').classList.remove('hidden');
    document.getElementById('previewPage').classList.add('hidden');
    document.getElementById('pageTitle').textContent = "Add Rows Form";
  }

  // Form submit handler for preview
  document.getElementById('dynamicForm').addEventListener('submit', function (event) {
    event.preventDefault();

    const formData = new FormData(this);
    const allRows = document.querySelectorAll('#rowsContainer .row');
    let rows = [];

    allRows.forEach((row, idx) => {
      const inputs = row.querySelectorAll('input, select');
      const date = inputs[0].value;
      const type = inputs[1].value;
      const provider = inputs[2].value;
      const desc = inputs[3].value;
      const wordCount = parseFloat(inputs[4].value);
      const rate = parseFloat(inputs[5].value);
      const total = (wordCount * rate).toFixed(2);

      const rowString = [date, type, provider, desc, wordCount, rate, total].join(':');
      rows.push(rowString);
    });

    previewData = {
      ty: 'AR',
      dt: rows.join(',')  // ðŸ”¹ Save the string exactly as required
    };

    document.getElementById('formPage').classList.add('hidden');
    document.getElementById('previewPage').classList.remove('hidden');
    document.getElementById('pageTitle').textContent = "Preview Details";

    updatePreview(previewData);
  });

  // Update preview table
  function updatePreview(result) {
    const rows = result.dt.split(',');
    const tbody = document.getElementById('previewTable').getElementsByTagName('tbody')[0];
    tbody.innerHTML = '';

    rows.forEach(row => {
      const rowData = row.split(':');
      const tr = document.createElement('tr');
      rowData.forEach(cell => {
        const td = document.createElement('td');
        td.textContent = cell;
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });
  }

  // Final submission
  async function submitData() {
    if (!previewData) {
      responseParagraph.textContent = "No preview data found.";
      return;
    }

    try {
      const res = await fetch('/api/submitData', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ result: previewData }),
      });

      if (!res.ok) throw new Error('Error submitting data');

      const contentType = res.headers.get('Content-Type');

      if (contentType && contentType.includes('application/json')) {
        const result1 = await res.json();

        if (result1.link) {
          window.location.href = result1.link;
        } else if (result1.base64html) {
          const decodedHTML = base64DecodeUnicode(result1.base64html);
          responseParagraph.innerHTML = decodedHTML;
        } else {
          responseParagraph.textContent = 'No valid data received in the response.';
        }
      } else if (contentType && contentType.includes('text/html')) {
        const htmlContent = await res.text();
        responseParagraph.innerHTML = htmlContent;
      } else {
        throw new Error('Unsupported response format from the server');
      }
    } catch (error) {
      responseParagraph.textContent = `Error: ${error.message}`;
    }
  }

  // Base64 decode helper
  function base64DecodeUnicode(str) {
    try {
      return decodeURIComponent(escape(window.atob(str)));
    } catch (e) {
      return "Invalid base64 HTML string";
    }
  }
</script>

</body>
</html>
